(function(){var t,e={}.hasOwnProperty,r=function(t,r){function n(){this.constructor=t}for(var i in r)e.call(r,i)&&(t[i]=r[i]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};"undefined"==typeof module?(window.a2r||(window.a2r={}),t=window.a2r.osc={}):t=module.exports,function(t){var e,n,i,s,o,a,u,f,h,c,d,p,l,g,w,y,m,b,v,A,I,E,B,T,O,S,z,P,D,_,U,M;m="function"==typeof Buffer,z=function(t){if(t=Number(t),0/0===t)throw Error("Value isn't a number");return t},O=function(t){return t=z(t),Math.round(t)},d=2208988800,w=function(t,e){var r,n;return 0===t&&1===e?new Date:(n=1e3*(t-d),n+=Math.round(1e3*e/4294967296),r=new Date(n),r.ntpSeconds=t,r.ntpFraction=e,r)},S=function(t){var e,r,n;return 1===t?[0,1]:Array.isArray(t)?t:(n=t.getTime(),r=Math.floor(n/1e3),e=Math.round(4294967296*(n%1e3)/1e3),[r+d,e])},u={i:{name:"integer",read:function(t){return t.readInt32()},write:function(t,e){return t.writeInt32(e)},cast:O,sizeOf:function(){return 4}},f:{name:"float",read:function(t){return t.readFloat()},write:function(t,e){return t.writeFloat(e)},cast:z,sizeOf:function(){return 4}},s:{name:"string",read:function(t){return t.readString()},write:function(t,e){return t.writeString(e)},cast:function(t){return""+t},sizeOf:function(t){return B(""+t)}},b:{name:"blob",read:function(t){return t.readBlob()},write:function(t,e){return t.writeBlob(e)},sizeOf:function(t){return A(t)}},d:{name:"double",read:function(t){return t.readDouble()},write:function(t,e){return t.writeDouble(e)},sizeOf:function(){return 8}},c:{name:"char",read:function(t){return String.fromCharCode(127&t.readInt32())},write:function(t,e){return t.writeInt32(e.charCodeAt(0))},cast:function(t){return(""+t).charAt(0)},sizeOf:function(){return 4}},r:{name:"color",read:function(t){return t.readInt32()},write:function(t,e){return t.writeInt32(e)},cast:O,sizeOf:function(){return 4}},t:{name:"time",read:function(t){return t.readTimetag()},write:function(t,e){return t.writeTimetag(e)},cast:function(t){return t instanceof Date?t:new Date(t)},sizeOf:function(){return 8}},T:{name:"true",read:function(){return!0}},F:{name:"false",read:function(){return!1}},N:{name:"null",read:function(){return null}},I:{name:"impulse",read:function(){return s}}},u.S=u.s,f={};for(p in u)P=u[p],"S"!==p&&(P.code=p),f[P.name]=P;a={Int32:{dataViewReader:"getInt32",dataViewWriter:"setInt32",bufferReader:"readInt32BE",bufferWriter:"writeInt32BE",size:4},UInt32:{dataViewReader:"getUint32",dataViewWriter:"setUint32",bufferReader:"readUInt32BE",bufferWriter:"writeUInt32BE",size:4},Float:{dataViewReader:"getFloat32",dataViewWriter:"setFloat32",bufferReader:"readFloatBE",bufferWriter:"writeFloatBE",size:4},Double:{dataViewReader:"getFloat64",dataViewWriter:"setFloat64",bufferReader:"readDoubleBE",bufferWriter:"writeDoubleBE",size:8}},b=function(t){return 4-t%4},s={},T=function(t){switch(typeof t){case"string":return"s";case"number":return"f";case"boolean":return t?"T":"F";case"undefined":throw Error("Value can't be undefined");case"object":if(null===t)return"N";if(t instanceof Date)return"t";if(m&&Buffer.isBuffer(t)||t instanceof ArrayBuffer)return"b";if(t===s)return"I";throw Error("Unsupported type `"+t+"`");default:throw Error("Unsupported type `"+t+"`")}},B=function(t){return t.length+b(t.length)},A=function(t){var e,r;return e=t instanceof ArrayBuffer?4+t.byteLength:4+t.length,r=b(e),4>r&&(e+=r),e},I=function(t,e){var r,n,i,s,o;for(n=16,o=t.elements,i=0,s=o.length;s>i;i++)r=o[i],n+=4+E(r,e);return n},E=function(t,e){var r,n,i,s,o,a,u;for(r=null!=e?e[t.address]:void 0,s=r?8:B(t.address),o=r?t.typeTag.length+2:t.typeTag.length+1,s+=o+b(o),n=0,i=t.typeTag.length;i>n;)a=t.typeTag.charAt(n),u=t.arguments[n++],s+=v(u,a);return s},v=function(t,e){if(e){if(P=u[e]||f[e],!P)throw Error("Type `"+e+"` isn't supported");return P.sizeOf?P.sizeOf(t):0}return e=T(t),v(t,e)},o=function(){function t(t,e,r){var n,i,s,o,a,h,c;if(this.address=t,this.arguments=[],e&&null==r&&(r=e,e=null),void 0!==r)if(Array.isArray(r)||(r=[r]),e){if(r.length!==e.length)throw Error("Arguments length doesn't match typetag length");for(i=o=0,h=r.length;h>o;i=++o)n=r[i],this.add(e.charAt(i),n)}else for(a=0,c=r.length;c>a;a++){if(s=r[a],p=null,"object"==typeof s&&null!=(null!=s?s.type:void 0)){if(p=s.type,P=u[p]||f[p],!P)throw Error("Unsupported type `"+p+"`");s=P.sizeOf?s.value:P.read()}p?this.add(p,s):this.add(s)}}return t.prototype.add=function(t,e){if(void 0===e&&(e=t,t=null),t){if(P=u[t]||f[t],!P)throw Error("Unsupported type `"+t+"`");P.cast&&(e=P.cast(e))}else t=T(e),P=u[t];return this.arguments.push(e),this.typeTag?this.typeTag+=t:this.typeTag=t,this},t.prototype.toBuffer=function(t){return m?new OscBufferPacketGenerator(this,t).generate():new h(this,t).generate()},t.prototype.equal=function(e){var r,n,i,s,o;if(!(e instanceof t))return!1;if(e.address!==this.address)return!1;if(e.typeTag!==this.typeTag)return!1;if(e.arguments.length!==this.arguments.length)return!1;for(o=this.arguments,n=i=0,s=o.length;s>i;n=++i)if(r=o[n],e.arguments[n]!==r)return!1;return!0},t}(),i=function(){function t(t,e){var r,n,i,s;for(t instanceof Date?this.timetag=t:1===t?this.timetag=new Date:(this.timetag=new Date,e=t),e?(Array.isArray(e)||(e=[e]),this.elements=e):this.elements=[],s=this.elements,n=0,i=s.length;i>n;n++)if(r=s[n],!r instanceof o)throw Error("A bundle element must be an instance of Message")}return t.prototype.addElement=function(t,e,r){var n;return t instanceof o?(this.elements.push(t),t):(n=new o(t,e,r),this.elements.push(n),n)},t.prototype.message=function(t,e,r){return this.addElement(t,e,r),this},t.prototype.toBuffer=function(t){return m?new OscBufferPacketGenerator(this,t).generate():new h(this,t).generate()},t.prototype.equal=function(e){var r,n,i,s,o;if(!(e instanceof t))return!1;if(e.timetag!==this.timetag)return!1;if(e.elements.length!==this.elements.length)return!1;for(o=this.elements,n=i=0,s=o.length;s>i;n=++i)if(r=o[n],!r.equal(e.elements[n]))return!1;return!0},t}(),e=function(){function t(t,e){this.dict=e,t instanceof i?(this.bundle=t,this.size=I(this.bundle,this.dict)):(this.message=t,this.size=E(this.message,this.dict))}return t.prototype.generateMessage=function(t){var e,r,n,i,s;for(this.dict&&(e=this.dict[t.address])?(this.writeUInt32(788529152),this.writeString(",i"+t.typeTag),this.writeInt32(O(e))):(this.writeString(t.address),this.writeString(","+t.typeTag)),r=0,n=t.typeTag.length,s=[];n>r;){if(p=t.typeTag.charAt(r),i=t.arguments[r++],P=u[p],!P)throw Error("Type `"+p+"` isn't supported");P.write?s.push(P.write(this,i)):s.push(void 0)}return s},t.prototype.generateBundle=function(t){var e,r,n,i,s;for(this.writeString("#bundle"),r=t.timetag<=new Date?[0,1]:S(t.timetag),this.writeTimetag(r),s=t.elements,n=0,i=s.length;i>n;n++)e=s[n],this.writeInt32(E(e,this.dict)),this.generateMessage(e);return null},t.prototype.writeTimetag=function(t){var e;return e=S(t),this.writeUInt32(e[0]),this.writeUInt32(e[1])},t.prototype.generate=function(){return this.bundle?this.generateBundle(this.bundle):this.generateMessage(this.message),this.buffer},t.prototype.writeString=function(t,e){throw null==e&&(e="ascii"),Error("Abstract method `AbstractOscPacketGenerator::writeString` called")},t}(),D=function(t){return t="write"+t,e.prototype[t]=function(){throw Error("Abstract method `AbstractOscPacketGenerator::"+t+"` called")}};for(y in a)l=a[y],D(y);h=function(t){function e(t,r){e.__super__.constructor.call(this,t,r),this.buffer=new ArrayBuffer(this.size),this.view=new DataView(this.buffer),this.pos=0}return r(e,t),e.prototype.writeString=function(t,e){var r,n,i,s,o;if(null==e&&(e="ascii"),"ascii"!==e)throw Error("OscBufferWriter::writeString only supports ASCII encoding for ArrayBuffer");for(i=t.length,n=0;i>n;)r=t.charCodeAt(n++),this.view.setInt8(this.pos++,127&r);for(s=b(i),n=0,o=[];s>n;)this.view.setInt8(this.pos++,0),o.push(n++);return o},e.prototype.writeBlob=function(t){var e,r,n,i;if(m&&Buffer.isBuffer(t)){for(n=t.length,this.writeInt32(n),r=0;n>r;)this.view.setInt8(this.pos+r,t[r]),r++;this.pos+=n}else{for(n=t.byteLength,e=new Int8Array(t),this.writeInt32(n),r=0;n>r;)this.view.setInt8(this.pos+r,e[r]),r++;this.pos+=n}if(i=b(4+n),i&&4>i){for(r=0;i>r;)this.view.setInt8(this.pos+r,0),r++;return this.pos+=i}},e}(e),_=function(t,e){return h.prototype["write"+t]=function(t){return t=this.view[e.dataViewWriter](this.pos,t,!1),this.pos+=e.size,t}};for(P in a)l=a[P],_(P,l);n=function(){function t(t,e,r){null==e&&(e=0),this.buffer=t,"object"==typeof e?(this.dict=e,this.pos=0):(this.dict=r,this.pos=e)}return t.prototype.parse=function(){var t;return t=this.readString(),"#bundle"===t?this._parseBundle():this._parseMessage(t)},t.prototype._parseMessage=function(t){var e,r,n;if("/"!==t.charAt(0))throw Error("A address must start with a '/'");if(!this.dict||"/"!==t&&"/?"!==t)n=this.readTypeTag(),r=this.parseArguments(n);else{if(n=this.readTypeTag(),r=this.parseArguments(n),"i"!==n.charAt(0))throw Error("Messages with compressed addresses must have an integer as first arguments type");if(n=n.slice(1,1),e=r.shift(),t=this.dict[e],!t)throw Error("No address with id `"+e+"` found")}return new o(t,n,r)},t.prototype._parseBundle=function(){var t,e,r,n;for(n=this.readTimetag(),e=[];!this.isEnd();)r=this.readInt32(),t=this.pos+r,e.push(this.parse());return new i(n,e)},t.prototype.parseArguments=function(t,e){var r,n;for(r=0,n=[];t.length>r;){if(e&&this.pos>=e)throw Error("Message boundary reached");if(p=t.charAt(r++),P=u[p],!P)throw Error("Type `"+p+"` isn't supported");n.push(P.read(this))}return n},t.prototype.readTypeTag=function(){var t;if(t=this.readString(),","!==t.charAt(0))throw Error("A type tag must start with a ','");return t=t.slice(1)},t.prototype.readTimetag=function(){return w(this.readUInt32(),this.readUInt32())},t.prototype.readString=function(){throw Error("Abstract method `AbstractOscPacketParser::writeString` called")},t.prototype.isEnd=function(){throw Error("Abstract method `AbstractOscPacketParser::isEnd` called")},t}(),U=function(t){return t="read"+t,n.prototype[t]=function(){throw Error("Abstract method `AbstractOscPacketParser::"+t+"` called")}};for(y in a)l=a[y],U(y);c=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.view=new DataView(this.buffer)}return r(e,t),e.prototype.isEnd=function(){return 0===this.buffer.byteLength||this.pos===this.buffer.byteLength},e.prototype.toString=function(t,e,r){var n,i;for(e=null!=e?e:0,r=null!=r?r:this.buffer.byteLength,i="";r>e;)n=this.view.getInt8(e++),i+=String.fromCharCode(127&n);return i},e.prototype.readBlob=function(t){var e,r,n,i;for(null==t&&(t=!0),i=this.readInt32(),r=0,e=new Int8Array(new ArrayBuffer(i));i>r;)e[r]=this.view.getInt8(this.pos+r),r++;return t&&(n=b(4+i),4>n&&(i+=n),this.pos+=i),e.buffer},e.prototype.readString=function(t,e){var r,n,i,s,o;if(null==t&&(t="ascii"),null==e&&(e=!0),this.isEnd())throw Error("No data left");for(r=4,n=!1;(i=this.pos+r-1)<this.buffer.byteLength;){if(0===this.view.getInt8(i)){n=!0;break}r+=4}if(0===r||n===!1)throw Error("No string data found");for(o=r-4;r>o&&0!==this.view.getInt8(this.pos+o);)o++;return s=this.toString(t,this.pos,this.pos+o),e&&(this.pos+=r),s},e}(n),M=function(t,e){return c.prototype["read"+t]=function(t){var r;return null==t&&(t=!0),r=this.view[e.dataViewReader](this.pos,!1),t&&(this.pos+=e.size),r}};for(P in a)l=a[P],M(P,l);return g=function(t,e,r){return m&&Buffer.isBuffer(t)?new OscBufferPacketParser(t,e,r).parse():new c(t,e,r).parse()},t.NUMBERS=a,t.toNTP=S,t.Message=o,t.Bundle=i,t.Impulse=s,t.AbstractOscPacketGenerator=e,t.AbstractOscPacketParser=n,t.OscArrayBufferPacketGenerator=h,t.OscArrayBufferPacketParser=c,t.fromBuffer=g}(t)}).call(this);